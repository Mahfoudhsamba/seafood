{% extends "layouts/base.html" %}
{% load static %}

{% block title %}Gérer les Permissions - Seafood Portal{% endblock %}

{% block content %}
<div class="pb-5">
  <div class="row align-items-center justify-content-between g-3 mb-4">
    <div class="col-auto">
      <h2 class="mb-0">Gérer les Permissions</h2>
    </div>
    <div class="col-auto">
      <a href="{% url 'authentication:role_detail' role.pk %}" class="btn btn-secondary">
        <span class="fas fa-arrow-left me-2"></span>Retour aux détails
      </a>
    </div>
  </div>

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}

  <div class="card mb-3">
    <div class="card-header">
      <h5 class="mb-0">Rôle: {{ role.name }}</h5>
    </div>
    <div class="card-body">
      <p class="text-muted mb-0">{{ role.description|default:"Aucune description" }}</p>
    </div>
  </div>

  <div class="card">
    <div class="card-body">
      <form method="post">
        {% csrf_token %}

        {% if form.non_field_errors %}
          <div class="alert alert-danger">
            {{ form.non_field_errors }}
          </div>
        {% endif %}

        <div class="alert alert-info" role="alert">
          <span class="fas fa-info-circle me-2"></span>
          Sélectionnez les permissions que vous souhaitez accorder à ce rôle. Les permissions sont regroupées par application.
        </div>

        {% if permissions_by_app %}
          {% for app, perms in permissions_by_app.items %}
            <div class="card mb-3">
              <div class="card-header">
                <h6 class="mb-0">
                  <span class="fas fa-cube me-2"></span>{{ app }}
                  <span class="badge bg-secondary ms-2">{{ perms|length }} permission{{ perms|length|pluralize }}</span>
                </h6>
              </div>
              <div class="card-body">
                <div class="row g-3">
                  {% for perm in perms %}
                    <div class="col-md-6">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox"
                               name="permissions" value="{{ perm.id }}"
                               id="perm_{{ perm.id }}"
                               {% if perm in role.permissions.all %}checked{% endif %}>
                        <label class="form-check-label" for="perm_{{ perm.id }}">
                          <strong>{{ perm.name }}</strong>
                          <br>
                          <small class="text-muted">{{ perm.content_type.app_label }}.{{ perm.codename }}</small>
                        </label>
                      </div>
                    </div>
                  {% endfor %}
                </div>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <div class="alert alert-warning" role="alert">
            Aucune permission disponible.
          </div>
        {% endif %}

        <div class="mt-4">
          <button type="submit" class="btn btn-primary">
            <span class="fas fa-save me-2"></span>Enregistrer les permissions
          </button>
          <a href="{% url 'authentication:role_detail' role.pk %}" class="btn btn-secondary">
            <span class="fas fa-times me-2"></span>Annuler
          </a>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Ajouter des boutons pour sélectionner/désélectionner toutes les permissions d'une app
  document.querySelectorAll('.card-header').forEach(function(header) {
    const badge = header.querySelector('.badge');
    if (badge) {
      const selectAllBtn = document.createElement('button');
      selectAllBtn.type = 'button';
      selectAllBtn.className = 'btn btn-sm btn-outline-primary ms-2';
      selectAllBtn.innerHTML = '<span class="fas fa-check-square me-1"></span>Tout';
      selectAllBtn.onclick = function() {
        const card = header.closest('.card');
        card.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
      };

      const deselectAllBtn = document.createElement('button');
      deselectAllBtn.type = 'button';
      deselectAllBtn.className = 'btn btn-sm btn-outline-secondary ms-1';
      deselectAllBtn.innerHTML = '<span class="fas fa-square me-1"></span>Aucun';
      deselectAllBtn.onclick = function() {
        const card = header.closest('.card');
        card.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
      };

      header.querySelector('h6').appendChild(selectAllBtn);
      header.querySelector('h6').appendChild(deselectAllBtn);
    }
  });
});
</script>
{% endblock %}
