{% extends 'layouts/base.html' %}
{% load static %}

{% block title %}Services - Entreprise de Pêche Artisanale{% endblock %}

{% block content %}

    <div class="inner-hero">
        <div class="container">
            <div class="rwo">
                <div class="col-lg-8 m-auto text-cetner">
                    <div class="main-heading">
                        <h1>Nos Services</h1>
                        <div class="page-intro">
                            <p>Découvrez la gamme complète de nos services dans le domaine des produits de mer.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <img src="{% static 'assets/img/shapes/inner-hero-shape1.png' %}" alt="" class="shape1">
        <img src="{% static 'assets/img/shapes/inner-hero-shape2.png' %}" alt="" class="shape2">
        <img src="{% static 'assets/img/shapes/inner-hero-shape3.png' %}" alt="" class="shape3">
    </div>

    <div class="about-page-service service-page sp">
        <div class="container">
            <!-- Barre de recherche -->
            <div class="row mb-5">
                <div class="col-12">
                    <div class="search-box-services">
                        <input type="text" class="form-control" id="servicesSearchInput" placeholder="Rechercher un service..." value="{{ search_query }}">
                    </div>
                </div>
            </div>

            <!-- Liste des services -->
            <div class="row" id="servicesContainer">
                {% if services %}
                    {% for service in services %}
                    <div class="col-lg-4 col-md-6">
                        <div class="service2-box">
                            {% if service.image %}
                            <div class="icon">
                                <img src="{{ service.image.url }}" alt="{{ service.name }}" style="max-width: 80px; max-height: 80px; object-fit: contain;">
                            </div>
                            {% else %}
                            <div class="icon">
                                <img src="{% static 'assets/img/icons/about-service-icon1.svg' %}" alt="">
                            </div>
                            {% endif %}
                            <div class="heading2">
                                <h4><a href="{% url 'service_detail' service.slug %}">{{ service.name }}</a></h4>
                                <div class="space16"></div>
                                <p>{{ service.description|truncatewords:30 }}</p>
                                <div class="space20"></div>
                                <a class="button" href="{% url 'service_detail' service.slug %}">En savoir plus <span class="arrow"><i class="fa-solid fa-angle-right"></i></span></a>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="col-12">
                        <div class="alert alert-info text-center">
                            <h5>Aucun service trouvé</h5>
                            <p>Essayez de modifier votre recherche.</p>
                        </div>
                    </div>
                {% endif %}
            </div>
            <div class="space30"></div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('servicesSearchInput');
    const servicesContainer = document.getElementById('servicesContainer');
    const servicesCount = document.getElementById('servicesCount');
    let searchDebounceTimer;

    // Fonction pour charger les services via AJAX
    function loadServices() {
        const searchQuery = searchInput.value.trim();

        // Construire l'URL avec les paramètres
        const params = new URLSearchParams();
        if (searchQuery) {
            params.append('search', searchQuery);
        }

        const url = '{% url "services" %}' + (params.toString() ? '?' + params.toString() : '');

        // Mettre à jour l'URL dans le navigateur sans recharger
        history.pushState({}, '', url);

        // Récupérer les services via fetch
        fetch(url, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.text())
        .then(html => {
            // Parser le HTML
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const newContainer = doc.getElementById('servicesContainer');
            const newCount = doc.getElementById('servicesCount');

            if (newContainer) {
                servicesContainer.innerHTML = newContainer.innerHTML;
            }
            if (newCount) {
                servicesCount.textContent = newCount.textContent;
            }
        })
        .catch(error => {
            console.error('Erreur lors du chargement des services:', error);
        });
    }

    // Recherche automatique après avoir tapé
    searchInput.addEventListener('input', function() {
        clearTimeout(searchDebounceTimer);
        searchDebounceTimer = setTimeout(() => {
            loadServices();
        }, 800);
    });

    // Soumettre lors de la touche Entrée
    searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            clearTimeout(searchDebounceTimer);
            loadServices();
        }
    });

    // Gérer le bouton retour du navigateur
    window.addEventListener('popstate', function() {
        location.reload();
    });
});
</script>
{% endblock %}
