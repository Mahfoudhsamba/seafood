{% extends 'layouts/seafood/base.html' %}
{% load static %}
{% block title %}Galerie - Entreprise de Pêche Artisanale{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'seafood/assets/css/gallery.css' %}">
{% endblock %}

{% block content %}

<!-- Lightbox Modal -->
<div id="lightbox" class="lightbox-modal">
    <span class="lightbox-close">&times;</span>
    <div class="lightbox-content">
        <img id="lightbox-img" src="" alt="">
        <div id="lightbox-caption"></div>
    </div>
    <button class="lightbox-prev" onclick="changeImage(-1)">&#10094;</button>
    <button class="lightbox-next" onclick="changeImage(1)">&#10095;</button>
</div>

<div class="inner-hero">
    <div class="container">
        <div class="rwo">
            <div class="col-lg-8 m-auto text-cetner">
                <div class="main-heading">
                    <h1>Galerie Photos</h1>
                    <div class="page-intro">
                        <p>Découvrez nos installations, nos équipes et nos produits en images.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <img src="{% static 'seafood/assets/img/shapes/inner-hero-shape1.png' %}" alt="" class="shape1">
    <img src="{% static 'seafood/assets/img/shapes/inner-hero-shape2.png' %}" alt="" class="shape2">
    <img src="{% static 'seafood/assets/img/shapes/inner-hero-shape3.png' %}" alt="" class="shape3">
</div>

<div class="gallery-section sp">
    <div class="container">
        <div class="row mb-4">
            <div class="col-lg-6 mx-auto">
                <div class="search-box-gallery">
                    <input type="text" id="gallerySearchInput" class="form-control" placeholder="Rechercher dans la galerie..." value="{{ search_query }}">
                </div>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-12">
                <div class="gallery-count text-center">
                    <strong id="galleryCount">{{ gallery_images.count }}</strong> image(s) trouvée(s)
                </div>
            </div>
        </div>

        <div class="row" id="galleryContainer">
            {% if gallery_images %}
                {% for image in gallery_images %}
                <div class="col-lg-4 col-md-6 gallery-col">
                    <div class="gallery-item" onclick="openLightbox({{ forloop.counter0 }})">
                        <div class="image-wrapper">
                            <img src="{{ image.image.url }}" alt="{{ image.title }}">
                            <div class="overlay">
                                <i class="fa-solid fa-magnifying-glass-plus"></i>
                            </div>
                        </div>
                        <div class="gallery-caption">
                            <h5>{{ image.title }}</h5>
                            <p>{{ image.description|truncatewords:15 }}</p>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="col-12">
                    <div class="alert alert-info text-center">
                        <h5>Aucune image trouvée</h5>
                        <p>Essayez de modifier votre recherche.</p>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Données des images de la galerie (mise à jour dynamique)
let galleryImages = [];

// Initialiser les images depuis le template
document.addEventListener('DOMContentLoaded', function() {
    updateGalleryImages();

    const searchInput = document.getElementById('gallerySearchInput');
    const galleryContainer = document.getElementById('galleryContainer');
    const galleryCount = document.getElementById('galleryCount');
    let searchDebounceTimer;

    // Fonction pour mettre à jour les données d'images
    function updateGalleryImages() {
        galleryImages = [];
        document.querySelectorAll('.gallery-col').forEach((col, index) => {
            const img = col.querySelector('img');
            const title = col.querySelector('h5').textContent;
            const description = col.querySelector('p').textContent;
            galleryImages.push({
                src: img.src,
                caption: title + ' - ' + description
            });
        });
    }

    // Fonction pour charger les images via AJAX
    function loadGallery() {
        const searchQuery = searchInput.value.trim();

        // Construire l'URL avec les paramètres
        const params = new URLSearchParams();
        if (searchQuery) {
            params.append('search', searchQuery);
        }

        const url = '{% url "gallery" %}' + (params.toString() ? '?' + params.toString() : '');

        // Mettre à jour l'URL dans le navigateur sans recharger
        history.pushState({}, '', url);

        // Récupérer la galerie via fetch
        fetch(url, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.text())
        .then(html => {
            // Parser le HTML
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const newContainer = doc.getElementById('galleryContainer');
            const newCount = doc.getElementById('galleryCount');

            if (newContainer) {
                galleryContainer.innerHTML = newContainer.innerHTML;
                updateGalleryImages();
            }
            if (newCount) {
                galleryCount.textContent = newCount.textContent;
            }
        })
        .catch(error => {
            console.error('Erreur lors du chargement de la galerie:', error);
        });
    }

    // Recherche automatique après avoir tapé
    searchInput.addEventListener('input', function() {
        clearTimeout(searchDebounceTimer);
        searchDebounceTimer = setTimeout(() => {
            loadGallery();
        }, 800);
    });

    // Soumettre lors de la touche Entrée
    searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            clearTimeout(searchDebounceTimer);
            loadGallery();
        }
    });

    // Gérer le bouton retour du navigateur
    window.addEventListener('popstate', function() {
        location.reload();
    });
});

// Variables pour le lightbox
let currentImageIndex = 0;

// Ouvrir le lightbox
function openLightbox(index) {
    currentImageIndex = index;
    const lightbox = document.getElementById('lightbox');
    const img = document.getElementById('lightbox-img');
    const caption = document.getElementById('lightbox-caption');

    if (galleryImages[index]) {
        img.src = galleryImages[index].src;
        caption.innerHTML = galleryImages[index].caption;
        lightbox.style.display = 'block';
        document.body.style.overflow = 'hidden';
    }
}

// Fermer le lightbox
function closeLightbox() {
    document.getElementById('lightbox').style.display = 'none';
    document.body.style.overflow = 'auto';
}

// Changer d'image
function changeImage(direction) {
    currentImageIndex += direction;

    if (currentImageIndex >= galleryImages.length) {
        currentImageIndex = 0;
    } else if (currentImageIndex < 0) {
        currentImageIndex = galleryImages.length - 1;
    }

    const img = document.getElementById('lightbox-img');
    const caption = document.getElementById('lightbox-caption');

    img.style.animation = 'none';
    setTimeout(() => {
        img.src = galleryImages[currentImageIndex].src;
        caption.innerHTML = galleryImages[currentImageIndex].caption;
        img.style.animation = 'zoomIn 0.3s';
    }, 10);
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    const lightbox = document.getElementById('lightbox');
    const closeBtn = document.querySelector('.lightbox-close');

    if (!lightbox || !closeBtn) return;

    // Fermer avec le bouton X
    closeBtn.onclick = closeLightbox;

    // Fermer en cliquant en dehors de l'image
    lightbox.onclick = function(e) {
        if (e.target === lightbox) {
            closeLightbox();
        }
    };

    // Navigation au clavier
    document.addEventListener('keydown', function(e) {
        if (lightbox.style.display === 'block') {
            if (e.key === 'Escape') {
                closeLightbox();
            } else if (e.key === 'ArrowLeft') {
                changeImage(-1);
            } else if (e.key === 'ArrowRight') {
                changeImage(1);
            }
        }
    });
});
</script>
{% endblock %}
