{% extends "layouts/base.html" %}
{% load static %}

{% block title %}Liste des Demandes d'Achat{% endblock %}

{% block content %}

  <div class="row align-items-center justify-content-between g-3 mb-4">
    <div class="col-auto"><h2 class="mb-0">LISTE DES DEMANDES D'ACHAT</h2></div>
    <div class="col-auto">
      <div class="row g-3"> 
        <div class="col-auto">
          <a href="{% url 'portal_admin:purchaserequest_add' %}" class="btn btn-primary">
            <span class="fas fa-plus me-2"></span>Faire une demande
          </a>
        </div>
      </div>
    </div>
  </div>

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}
   
  <div class="row g-5 mt-2 mb-3">
    <div class="border-translucent" data-list='{"valueNames":["DEMANDE", "DATE", "ARTICLE", "DEMANDEUR", "ÉCHÉANCE", "STATUT", "ACTIONS"]}'>
      <div class="table-responsive scrollbar">
        <table class="table table-sm fs-9 mb-0">
          <thead>
            <tr>
              <th class="sort align-middle" scope="col" data-sort="DEMANDE">DEMANDE</th>
              <th class="sort align-middle" scope="col" data-sort="DATE">DATE</th>
              <th class="sort align-middle" scope="col" data-sort="ARTICLE">ARTICLE</th>
              <th class="sort align-middle" scope="col" data-sort="DEMANDEUR">DEMANDEUR</th>
              <th class="sort align-middle" scope="col" data-sort="ÉCHÉANCE">ÉCHÉANCE</th>
              <th class="sort align-middle" scope="col" data-sort="STATUT">STATUT</th>
              <th class="sort align-middle text-end" scope="col" data-sort="ACTIONS">ACTIONS</th>
            </tr>
          </thead>
          <tbody class="list" id="customer-order-table-body">
            {% for pr in purchase_requests %}
              <tr class="hover-actions-trigger btn-reveal-trigger position-static">
                <td class="DEMANDE align-middle ps-0">
                  <a class="fw-semibold" href="{% url 'portal_admin:purchaserequest_detail' pr.pk %}">{{ pr.pr_number }}</a>
                </td>
                <td class="DATE align-middle fs-9">
                  {{ pr.pr_date|date:"d/m/Y" }}
                </td>
                <td class="ARTICLE align-middle fw-semibold text-body-highlight">
                  {% with items=pr.items.all %}
                    {% if items %}
                      <span class="badge badge-phoenix badge-phoenix-info">{{ items|length }} article{{ items|length|pluralize }}</span>
                    {% else %}
                      <span class="text-muted">-</span>
                    {% endif %}
                  {% endwith %}
                </td>
                <td class="DEMANDEUR align-middle text-body fs-8">
                  <div class="flex-1">
                    <h6 class="mb-0">{{ pr.requester_first_name }} {{ pr.requester_last_name }}</h6>
                    <small class="text-muted">{{ pr.position }}</small>
                  </div>
                </td>
                <td class="ÉCHÉANCE align-middle fw-bold text-body-tertiary">
                  {{ pr.pr_date|date:"d/m/Y" }}
                </td>
                <td class="STATUT align-middle text-start fw-bold text-body-tertiary">
                  {% if pr.status == 'draft' %}
                    <span class="badge badge-phoenix fs-10 badge-phoenix-warning">
                      <span class="badge-label">{{ pr.get_status_display }}</span>
                      <span class="ms-1" data-feather="edit" style="height:12.8px;width:12.8px;"></span>
                    </span>
                  {% elif pr.status == 'approved' %}
                    <span class="badge badge-phoenix fs-10 badge-phoenix-success">
                      <span class="badge-label">{{ pr.get_status_display }}</span>
                      <span class="ms-1" data-feather="check" style="height:12.8px;width:12.8px;"></span>
                    </span>
                  {% elif pr.status == 'rejected' %}
                    <span class="badge badge-phoenix fs-10 badge-phoenix-danger">
                      <span class="badge-label">{{ pr.get_status_display }}</span>
                      <span class="ms-1" data-feather="x-circle" style="height:12.8px;width:12.8px;"></span>
                    </span> 
                  {% elif pr.status == 'cancelled' %}
                    <span class="badge badge-phoenix fs-10 badge-phoenix-primary">
                      <span class="badge-label">{{ pr.get_status_display }}</span>
                      <span class="ms-1" data-feather="trash-2" style="height:12.8px;width:12.8px;"></span>
                    </span>  
                  {% endif %}
                  
                </td>
                <td class="ACTIONS align-middle text-end">
                  <a href="{% url 'portal_admin:purchaserequest_detail' pr.pk %}" title="Détails"><span class="text-body fs-5" data-feather="eye"></span></a>
                  <a href="" title="Imprimer"><span class="text-body fs-5" data-feather="printer"></span></span></a>
                  {% if pr.status == 'draft' %}
                    <a href="{% url 'portal_admin:purchaserequest_edit' pr.pk %}" title="Modifier"><span class="text-body fs-5" data-feather="edit"></span></span></a>
                  {% endif %}
                  </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="7" class="text-center py-4">
                  <p class="text-muted mb-0">Aucune demande d'achat trouvée</p>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
{% endblock %}