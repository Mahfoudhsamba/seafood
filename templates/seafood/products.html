{% extends 'layouts/seafood/base.html' %}
{% load static %}
{% block title %}Produits - Entreprise de Pêche Artisanale{% endblock %}

{% block content %}
    <div class="inner-hero">
        <div class="container">
            <div class="rwo">
                <div class="col-lg-8 m-auto text-cetner">
                    <div class="main-heading">
                        <h1>Nos Produits</h1>
                    </div>
                </div>
            </div>
        </div>
      <img src="{% static 'assets/img/shapes/inner-hero-shape1.png' %}" alt="" class="shape1">
      <img src="{% static 'assets/img/shapes/inner-hero-shape2.png' %}" alt="" class="shape2">
      <img src="{% static 'assets/img/shapes/inner-hero-shape3.png' %}" alt="" class="shape3">
    </div>

    <div class="shop-details-area sp">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 sp-right30">
                    <div class="row shop-page-sec">
                        {% if products %}
                            {% for product in products %}
                            <div class="col-md-6 mb-4">
                                <div class="card card-hover">
                                    <a href="{% url 'product_detail' product.slug %}">
                                        <img src="{{ product.image.url }}" class="card-img-top" alt="{{ product.product }}" style="height: 250px; object-fit: contain; background-color: #f8f9fa; padding: 10px;">
                                    </a>
                                    <div class="card-body">
                                        <a href="?category={{ product.category }}" class="badge bg-info mb-3">{{ product.get_category_display }}</a>
                                        <h3><a href="{% url 'product_detail' product.slug %}" class="text-inherit">{{ product.product }}</a></h3>
                                        <p>{{ product.description|truncatewords:20 }}</p>
                                        <div class="row align-items-center g-0 mt-2">
                                            <div class="col lh-1">
                                                <h6 class="mb-1">{{ product.product|upper }}</h6>
                                                <p class="fs-6 mb-0">
                                                    {% if product.minimum_order %}
                                                        {{ product.minimum_order }} Kg
                                                    {% endif %}
                                                    {% if product.scientific_name %}
                                                        | {{ product.scientific_name }}
                                                    {% endif %}
                                                </p>
                                            </div>
                                            <div class="col-auto">
                                                <a href="{% url 'product_detail' product.slug %}" class="btn btn-outline-primary btn-sm">
                                                    Voir Détails <i class="fa-solid fa-arrow-right-long"></i>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="col-12">
                                <div class="alert alert-info text-center">
                                    <h4>Aucun produit disponible pour le moment</h4>
                                    <p>Veuillez revenir plus tard ou contacter notre service commercial.</p>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="shop-left-area details-sidebar">
                        <div class="sidebar-box mb40">
                            <h3 class="mb-4">Rechercher</h3>
                            <div class="position-relative">
                                <form method="get" action="{% url 'products' %}" id="searchForm">
                                    <input type="text" class="form-control" name="search" id="searchInput" placeholder="Rechercher un produit..." value="{{ search_query }}" autocomplete="off">
                                    {% for cat in selected_categories %}
                                        <input type="hidden" name="category" value="{{ cat }}" class="search-category-input">
                                    {% endfor %}
                                </form>
                                <div id="searchSuggestions" class="search-suggestions" style="display: none;"></div>
                            </div>
                        </div>
                        
                        <div class="filter-area">
                            <h3>Filtrer par catégorie</h3>
                            <div class="space24"></div>
                            <form method="get" action="{% url 'products' %}" id="filterForm">
                                <!-- Conserver la recherche lors du filtrage -->
                                <input type="hidden" name="search" id="filterSearchInput" value="{{ search_query }}">
                                <div class="filter level-filter level-req">
                                    {% for cat_code, cat_name in categories %}
                                    <div class="form-check mb-3">
                                        <input class="form-check-input category-checkbox" type="checkbox" name="category" value="{{ cat_code }}" id="category-{{ cat_code }}"
                                               {% if cat_code in selected_categories %}checked{% endif %}>
                                        <label class="form-check-label" for="category-{{ cat_code }}">
                                            {{ cat_name }}
                                        </label>
                                    </div>
                                    {% endfor %}
                                </div>
                                <div class="mt-3">
                                    <a href="{% url 'products' %}" class="btn btn-outline-secondary btn-sm w-100">
                                        <i class="fa-solid fa-rotate-left"></i> Réinitialiser
                                    </a>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('searchInput');
        const suggestionsDiv = document.getElementById('searchSuggestions');
        const categoryCheckboxes = document.querySelectorAll('.category-checkbox');
        const productsContainer = document.querySelector('.shop-page-sec');
        let debounceTimer;
        let searchDebounceTimer;

        // Fonction pour récupérer et afficher les produits via AJAX
        function loadProducts() {
            const searchQuery = searchInput.value.trim();
            const selectedCategories = Array.from(categoryCheckboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);

            // Construire l'URL avec les paramètres
            const params = new URLSearchParams();
            if (searchQuery) {
                params.append('search', searchQuery);
            }
            selectedCategories.forEach(cat => {
                params.append('category', cat);
            });

            const url = '{% url "products" %}' + (params.toString() ? '?' + params.toString() : '');

            // Mettre à jour l'URL dans le navigateur sans recharger
            history.pushState({}, '', url);

            // Récupérer les produits via fetch
            fetch(url, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.text())
            .then(html => {
                // Extraire uniquement la section des produits
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const newProducts = doc.querySelector('.shop-page-sec');

                if (newProducts) {
                    productsContainer.innerHTML = newProducts.innerHTML;
                }
            })
            .catch(error => {
                console.error('Erreur lors du chargement des produits:', error);
            });
        }

        // Recherche automatique après avoir tapé
        searchInput.addEventListener('input', function() {
            clearTimeout(searchDebounceTimer);
            const query = this.value.trim();

            // Afficher les suggestions
            clearTimeout(debounceTimer);
            if (query.length >= 2) {
                debounceTimer = setTimeout(() => {
                    fetchSuggestions(query);
                }, 300);
            } else {
                suggestionsDiv.style.display = 'none';
            }

            // Charger les produits après 800ms
            searchDebounceTimer = setTimeout(() => {
                loadProducts();
            }, 800);
        });

        // Soumettre lors de la touche Entrée
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                clearTimeout(searchDebounceTimer);
                suggestionsDiv.style.display = 'none';
                loadProducts();
            }
        });

        // Filtrage automatique à chaque coche/décoche
        categoryCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                loadProducts();
            });
        });

        // Récupérer les suggestions via API
        function fetchSuggestions(query) {
            fetch(`/api/product-search/?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    displaySuggestions(data.suggestions);
                })
                .catch(error => {
                    console.error('Erreur lors de la récupération des suggestions:', error);
                });
        }

        // Afficher les suggestions
        function displaySuggestions(suggestions) {
            if (suggestions.length === 0) {
                suggestionsDiv.style.display = 'none';
                return;
            }

            let html = '';
            suggestions.forEach(item => {
                html += `
                    <div class="suggestion-item" data-slug="${item.slug}">
                        <div class="suggestion-name">${item.name}</div>
                        <div class="suggestion-details">
                            ${item.local_name ? item.local_name : ''}
                            <span class="suggestion-category">${item.category}</span>
                        </div>
                    </div>
                `;
            });

            suggestionsDiv.innerHTML = html;
            suggestionsDiv.style.display = 'block';

            // Ajouter les événements de clic sur les suggestions
            document.querySelectorAll('.suggestion-item').forEach(item => {
                item.addEventListener('click', function() {
                    clearTimeout(searchDebounceTimer);
                    const slug = this.dataset.slug;
                    window.location.href = `/products/${slug}/`;
                });
            });
        }

        // Fermer les suggestions quand on clique ailleurs
        document.addEventListener('click', function(e) {
            if (!searchInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
                suggestionsDiv.style.display = 'none';
            }
        });

        // Empêcher la fermeture lors du clic sur les suggestions
        suggestionsDiv.addEventListener('click', function(e) {
            e.stopPropagation();
        });

        // Gérer le bouton retour du navigateur
        window.addEventListener('popstate', function() {
            location.reload();
        });
    });
</script>
{% endblock %}