{% extends "layouts/base.html" %}
{% load static %}

{% block title %}Détails de la Caisse - {{ cashbox.folder_code }}{% endblock %}

{% block content %}
<div class="pb-5">
  <div class="row align-items-center justify-content-between g-3 mb-4">
    <div class="col-auto">
      <h2 class="mb-0">Détails de la Caisse</h2>
    </div>
    <div class="col-auto">
      <a href="{% url 'portal_admin:cashbox_list' %}" class="btn btn-phoenix-secondary me-2">
        <span class="fas fa-arrow-left me-2"></span>Retour
      </a>
      <a href="{% url 'portal_admin:cashbox_edit' cashbox.pk %}" class="btn btn-primary me-2">
        <span class="fas fa-edit me-2"></span>Modifier
      </a>
      <div class="btn-group me-2" role="group">
        <button type="button" class="btn btn-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
          <span class="fas fa-exchange-alt me-2"></span>Changer statut
        </button>
        <ul class="dropdown-menu">
          {% if cashbox.status != 'active' %}
          <li>
            <a class="dropdown-item" href="{% url 'portal_admin:cashbox_change_status' cashbox.pk 'active' %}">
              <span class="fas fa-check text-success me-2"></span>Activer
            </a>
          </li>
          {% endif %}
          {% if cashbox.status != 'inactive' %}
          <li>
            <a class="dropdown-item" href="{% url 'portal_admin:cashbox_change_status' cashbox.pk 'inactive' %}">
              <span class="fas fa-times text-secondary me-2"></span>Désactiver
            </a>
          </li>
          {% endif %}
          {% if cashbox.status != 'suspended' %}
          <li>
            <a class="dropdown-item" href="{% url 'portal_admin:cashbox_change_status' cashbox.pk 'suspended' %}">
              <span class="fas fa-pause text-warning me-2"></span>Suspendre
            </a>
          </li>
          {% endif %}
        </ul>
      </div>
      <a href="{% url 'portal_admin:cashbox_fund' cashbox.pk %}" class="btn btn-success">
        <span class="fas fa-plus-circle me-2"></span>Alimenter
      </a>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-12 col-xl-8">
      <div class="card mb-3">
        <div class="card-header bg-light">
          <h5 class="mb-0">Informations de la caisse</h5>
        </div>
        <div class="card-body">
          <div class="row mb-3">
            <div class="col-sm-4"><strong>Dossier :</strong></div>
            <div class="col-sm-8">{{ cashbox.folder_code }}</div>
          </div>
          <div class="row mb-3">
            <div class="col-sm-4"><strong>Préfixe :</strong></div>
            <div class="col-sm-8"><span class="badge bg-info">{{ cashbox.prefix }}</span></div>
          </div>
          {% if cashbox.description %}
          <div class="row mb-3">
            <div class="col-sm-4"><strong>Description :</strong></div>
            <div class="col-sm-8">{{ cashbox.description }}</div>
          </div>
          {% endif %}
          <div class="row mb-3">
            <div class="col-sm-4"><strong>Statut :</strong></div>
            <div class="col-sm-8">
              {% if cashbox.status == 'active' %}
                <span class="badge bg-success fs-6">{{ cashbox.get_status_display }}</span>
              {% elif cashbox.status == 'inactive' %}
                <span class="badge bg-secondary fs-6">{{ cashbox.get_status_display }}</span>
              {% elif cashbox.status == 'suspended' %}
                <span class="badge bg-warning fs-6">{{ cashbox.get_status_display }}</span>
              {% endif %}
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-sm-4"><strong>Solde actuel :</strong></div>
            <div class="col-sm-8"><strong class="text-success fs-3">{{ cashbox.current_balance|floatformat:2 }} MRU</strong></div>
          </div>
        </div>
      </div>

      <div class="row g-3 mb-3">
        <div class="col-md-4">
          <div class="card bg-success-subtle border-success">
            <div class="card-body">
              <div class="d-flex align-items-center justify-content-between">
                <div>
                  <p class="text-muted mb-1">Total Entrées</p>
                  <h4 class="text-success mb-0">+{{ total_in|floatformat:2 }} MRU</h4>
                </div>
                <div class="text-success">
                  <span class="fas fa-arrow-down fa-2x"></span>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card bg-danger-subtle border-danger">
            <div class="card-body">
              <div class="d-flex align-items-center justify-content-between">
                <div>
                  <p class="text-muted mb-1">Total Sorties</p>
                  <h4 class="text-danger mb-0">-{{ total_out|floatformat:2 }} MRU</h4>
                </div>
                <div class="text-danger">
                  <span class="fas fa-arrow-up fa-2x"></span>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card bg-primary-subtle border-primary">
            <div class="card-body">
              <div class="d-flex align-items-center justify-content-between">
                <div>
                  <p class="text-muted mb-1">Solde Actuel</p>
                  <h4 class="text-primary mb-0">{{ cashbox.current_balance|floatformat:2 }} MRU</h4>
                </div>
                <div class="text-primary">
                  <span class="fas fa-wallet fa-2x"></span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header bg-light">
          <h5 class="mb-0">Transactions</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead>
                <tr>
                  <th>N° Transaction</th>
                  <th>Date</th>
                  <th>Type</th>
                  <th>Mode</th>
                  <th>Détails</th>
                  <th>Montant</th>
                  <th>Solde après</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for transaction in transactions %}
                  <tr>
                    <td><strong>{{ transaction.transaction_number }}</strong></td>
                    <td>{{ transaction.transaction_date|date:"d/m/Y" }}</td>
                    <td>
                      {% if transaction.transaction_type == 'in' %}
                        <span class="badge bg-success">Entrée</span>
                      {% else %}
                        <span class="badge bg-warning">Sortie</span>
                      {% endif %}
                    </td>
                    <td>{{ transaction.get_source_display }}</td>
                    <td>
                      <small class="text-muted">{{ transaction.description|truncatewords:8 }}</small><br>
                      {% if transaction.source == 'mobile_transfer' and transaction.transaction_id %}
                        <small><strong>ID:</strong> {{ transaction.transaction_id }}</small>
                      {% elif transaction.source == 'check' and transaction.check_number %}
                        <small><strong>Chèque:</strong> {{ transaction.check_number }}</small>
                      {% elif transaction.source == 'deposit' and transaction.check_number %}
                        <small><strong>Versement:</strong> {{ transaction.check_number }}</small>
                      {% elif transaction.source == 'bank_transfer' and transaction.transfer_reference %}
                        <small><strong>Ref:</strong> {{ transaction.transfer_reference }}</small>
                      {% endif %}
                      {% if transaction.issuing_bank %}
                        <br><small class="text-info"><span class="fas fa-university"></span> {{ transaction.issuing_bank.bank_name }}</small>
                      {% endif %}
                    </td>
                    <td>
                      {% if transaction.transaction_type == 'in' %}
                        <strong class="text-success">+{{ transaction.amount|floatformat:2 }} MRU</strong>
                      {% else %}
                        <strong class="text-danger">-{{ transaction.amount|floatformat:2 }} MRU</strong>
                      {% endif %}
                    </td>
                    <td>{{ transaction.balance_after|floatformat:2 }} MRU</td>
                    <td>
                      {% if transaction.justification %}
                        <a href="{{ transaction.justification.url }}" target="_blank" class="btn btn-sm btn-phoenix-info" title="Voir pièce justificative">
                          <span class="fas fa-file"></span>
                        </a>
                      {% endif %}
                    </td>
                  </tr>
                {% empty %}
                  <tr>
                    <td colspan="8" class="text-center py-4">
                      <p class="text-muted mb-0">Aucune transaction trouvée</p>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-xl-4">
      <div class="card">
        <div class="card-header bg-light">
          <h5 class="mb-0">Métadonnées</h5>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <small class="text-muted">Créé le</small><br>
            <strong>{{ cashbox.created_at|date:"d/m/Y à H:i" }}</strong>
          </div>
          <div class="mb-3">
            <small class="text-muted">Modifié le</small><br>
            <strong>{{ cashbox.updated_at|date:"d/m/Y à H:i" }}</strong>
          </div>
          {% if cashbox.created_by %}
          <div class="mb-3">
            <small class="text-muted">Créé par</small><br>
            <strong>{{ cashbox.created_by.get_full_name|default:cashbox.created_by.username }}</strong>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
