{% extends 'layouts/seafood/base.html' %}
{% load static %}
{% block title %}FAQ - Entreprise de Pêche Artisanale{% endblock %}

{% block extra_css %}
<style>
.filter-sidebar {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 30px;
}

.search-box {
    margin-bottom: 20px;
}

.search-box input {
    width: 100%;
    padding: 10px 15px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 14px;
}

.category-filter .form-check {
    margin-bottom: 12px;
}

.category-filter label {
    cursor: pointer;
    font-weight: 500;
}

.faq-count {
    color: #666;
    font-size: 14px;
    margin-bottom: 20px;
}
</style>
{% endblock %}

{% block content %}
    <div class="inner-hero">
        <div class="container">
            <div class="rwo">
                <div class="col-lg-8 m-auto text-cetner">
                    <div class="main-heading">
                        <h1>Questions Fréquemment Posées</h1>
                        <div class="page-intro">
                            <p>FAQ's</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <img src="{% static 'assets/img/shapes/inner-hero-shape1.png' %}" alt="" class="shape1">
        <img src="{% static 'assets/img/shapes/inner-hero-shape2.png' %}" alt="" class="shape2">
        <img src="{% static 'assets/img/shapes/inner-hero-shape3.png' %}" alt="" class="shape3">
    </div>

    <div class="faq faq-page-sec sp">
        <div class="container">
            <div class="row">
                <div class="col-lg-3">
                    <div class="filter-sidebar">
                        <h4 class="mb-3">Rechercher</h4>
                        <div class="search-box">
                            <input type="text" id="faqSearchInput" placeholder="Rechercher une question..." value="{{ search_query }}">
                        </div>

                        <h4 class="mb-3 mt-4">Filtrer par service</h4>
                        <div class="category-filter">
                            {% for service in services %}
                            <div class="form-check">
                                <input class="form-check-input faq-service-checkbox" type="checkbox"
                                       value="{{ service.id }}" id="faq-service-{{ service.id }}"
                                       {% if service.id|stringformat:"s" in selected_services %}checked{% endif %}>
                                <label class="form-check-label" for="faq-service-{{ service.id }}">
                                    {{ service.name }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>

                        <div class="mt-3">
                            <a href="{% url 'faqs' %}" class="btn btn-outline-secondary btn-sm w-100">
                                <i class="fa-solid fa-rotate-left"></i> Réinitialiser
                            </a>
                        </div>
                    </div>
                </div>

                <div class="col-lg-9">
                    <div class="heading1 mb-4">
                        <span class="span"><img src="{% static 'assets/img/icons/span-icon1.png' %}" alt=""> FAQ's</span>
                        <h2>Questions Fréquemment Posées</h2>
                        <div class="space16"></div>
                        <p>Trouvez les réponses à vos questions les plus courantes concernant nos produits, nos services et nos pratiques.</p>
                    </div>

                    <div class="faq-count">
                        <strong id="faqCount">{{ faqs.count }}</strong> question(s) trouvée(s)
                    </div>

                    <div class="accordion" id="faqAccordion">
                        {% if faqs %}
                            {% for faq in faqs %}
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="heading{{ forloop.counter }}">
                                    <button class="accordion-button {% if not forloop.first %}collapsed{% endif %}"
                                            type="button" data-bs-toggle="collapse"
                                            data-bs-target="#collapse{{ forloop.counter }}"
                                            aria-expanded="{% if forloop.first %}true{% else %}false{% endif %}"
                                            aria-controls="collapse{{ forloop.counter }}">
                                        {% if faq.service %}
                                        <span class="badge bg-info me-2">{{ faq.service.name }}</span>
                                        {% endif %}
                                        {{ faq.question }}
                                    </button>
                                </h2>
                                <div id="collapse{{ forloop.counter }}"
                                     class="accordion-collapse collapse {% if forloop.first %}show{% endif %}"
                                     aria-labelledby="heading{{ forloop.counter }}"
                                     data-bs-parent="#faqAccordion">
                                    <div class="accordion-body">
                                        {{ faq.answer }}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="alert alert-info">
                                <h5>Aucune question trouvée</h5>
                                <p>Essayez de modifier vos critères de recherche ou de filtre.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    
    <div class="faq-bottom-area sp bg1">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 m-auto text-center">
                    <div class="heading1">
                        <span class="span"><img src="{% static 'assets/img/icons/span-icon1.png' %}" alt=""> Contact</span>
                        <h2>Vous Avez D'Autres Questions ?</h2>
                        <div class="space16"></div>
                        <p>Nous sommes là pour vous aider ! N'hésitez pas à nous contacter pour toute question supplémentaire.</p>
                        <div class="space30"></div>
                        <a href="{% url 'contact' %}" class="btn btn-primary btn-lg">
                            <i class="fa-solid fa-envelope"></i> Nous Contacter
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('faqSearchInput');
        const serviceCheckboxes = document.querySelectorAll('.faq-service-checkbox');
        const faqAccordion = document.getElementById('faqAccordion');
        const faqCount = document.getElementById('faqCount');
        let searchDebounceTimer;

        // Fonction pour charger les FAQs via AJAX
        function loadFAQs() {
            const searchQuery = searchInput.value.trim();
            const selectedServices = Array.from(serviceCheckboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);

            // Construire l'URL avec les paramètres
            const params = new URLSearchParams();
            if (searchQuery) {
                params.append('search', searchQuery);
            }
            selectedServices.forEach(serviceId => {
                params.append('service', serviceId);
            });

            const url = '{% url "faqs" %}' + (params.toString() ? '?' + params.toString() : '');

            // Mettre à jour l'URL dans le navigateur sans recharger
            history.pushState({}, '', url);

            // Récupérer les FAQs via fetch
            fetch(url, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.text())
            .then(html => {
                // Parser le HTML
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const newAccordion = doc.getElementById('faqAccordion');
                const newCount = doc.getElementById('faqCount');

                if (newAccordion) {
                    faqAccordion.innerHTML = newAccordion.innerHTML;
                }
                if (newCount) {
                    faqCount.textContent = newCount.textContent;
                }
            })
            .catch(error => {
                console.error('Erreur lors du chargement des FAQs:', error);
            });
        }

        // Recherche automatique après avoir tapé
        searchInput.addEventListener('input', function() {
            clearTimeout(searchDebounceTimer);
            searchDebounceTimer = setTimeout(() => {
                loadFAQs();
            }, 800);
        });

        // Soumettre lors de la touche Entrée
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                clearTimeout(searchDebounceTimer);
                loadFAQs();
            }
        });

        // Filtrage automatique à chaque coche/décoche
        serviceCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                loadFAQs();
            });
        });

        // Gérer le bouton retour du navigateur
        window.addEventListener('popstate', function() {
            location.reload();
        });
    });
</script>
{% endblock %}
