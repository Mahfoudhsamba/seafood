{% extends "layouts/base.html" %}
{% load static %}

{% block title %}Détails du Bon de Commande - {{ purchase_order.po_number }}{% endblock %}

{% block content %}
<div class="pb-5">
  <div class="row align-items-center justify-content-between g-3 mb-4">
    <div class="col-auto">
      <h2 class="mb-0">Bon de Commande {{ purchase_order.po_number }}</h2>
    </div>
    <div class="col-auto">
      <a href="{% url 'portal_admin:purchaseorder_list' %}" class="btn btn-phoenix-secondary me-2">
        <span class="fas fa-arrow-left me-2"></span>Retour
      </a>
      {% if purchase_order.status == 'draft' %}
        <a href="{% url 'portal_admin:purchaseorder_edit' purchase_order.pk %}" class="btn btn-primary me-2">
          <span class="fas fa-edit me-2"></span>Modifier
        </a>
      {% endif %}
    </div>
  </div>

  <div class="row g-3">
    <div class="col-12 col-xl-8">
      <div class="card mb-3">
        <div class="card-header bg-light">
          <h5 class="mb-0">Informations du bon de commande</h5>
        </div>
        <div class="card-body">
          <div class="row mb-3">
            <div class="col-sm-4"><strong>Numéro PO :</strong></div>
            <div class="col-sm-8"><span class="badge bg-primary fs-6">{{ purchase_order.po_number }}</span></div>
          </div>
          <div class="row mb-3">
            <div class="col-sm-4"><strong>Date PO :</strong></div>
            <div class="col-sm-8">{{ purchase_order.po_date|date:"d/m/Y" }}</div>
          </div>
          <div class="row mb-3">
            <div class="col-sm-4"><strong>Fournisseur :</strong></div>
            <div class="col-sm-8">
              <strong>{{ purchase_order.supplier.name }}</strong><br>
              <small class="text-muted">{{ purchase_order.supplier.accounting_code }}</small>
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-sm-4"><strong>Statut :</strong></div>
            <div class="col-sm-8">
              {% if purchase_order.status == 'paid' %}
                <span class="badge bg-success fs-6">{{ purchase_order.get_status_display }}</span>
              {% elif purchase_order.status == 'approved' %}
                <span class="badge bg-info fs-6">{{ purchase_order.get_status_display }}</span>
              {% elif purchase_order.status == 'cancelled' %}
                <span class="badge bg-danger fs-6">{{ purchase_order.get_status_display }}</span>
              {% elif purchase_order.status == 'draft' %}
                <span class="badge bg-secondary fs-6">{{ purchase_order.get_status_display }}</span>
              {% else %}
                <span class="badge bg-warning fs-6">{{ purchase_order.get_status_display }}</span>
              {% endif %}
            </div>
          </div>
          {% if purchase_order.rejection_reason %}
          <div class="row mb-3">
            <div class="col-sm-4"><strong>Motif {% if purchase_order.status == 'cancelled' %}d'annulation{% else %}de rejet{% endif %} :</strong></div>
            <div class="col-sm-8">
              <div class="alert alert-danger mb-0">
                <span class="fas fa-exclamation-circle me-2"></span>{{ purchase_order.rejection_reason }}
              </div>
            </div>
          </div>
          {% endif %}
          {% if purchase_order.note %}
          <div class="row mb-3">
            <div class="col-sm-4"><strong>Note :</strong></div>
            <div class="col-sm-8">{{ purchase_order.note }}</div>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Articles du bon de commande -->
      <div class="card mb-3">
        <div class="card-header bg-light">
          <h5 class="mb-0">Articles commandés</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-bordered table-striped">
              <thead class="table-light">
                <tr>
                  <th width="35%">Désignation</th>
                  <th width="10%" class="text-end">Quantité</th>
                  <th width="10%">Unité</th>
                  <th width="15%" class="text-end">Prix unitaire</th>
                  <th width="10%" class="text-end">Taxe (%)</th>
                  <th width="20%" class="text-end">Montant TTC</th>
                </tr>
              </thead>
              <tbody>
                {% for item in purchase_order.items.all %}
                <tr>
                  <td>{{ item.designation }}</td>
                  <td class="text-end">{{ item.quantity|floatformat:2 }}</td>
                  <td>{{ item.get_unit_display }}</td>
                  <td class="text-end">{{ item.unit_price|floatformat:2 }} MRU</td>
                  <td class="text-end">{{ item.tax_rate|floatformat:2 }}%</td>
                  <td class="text-end"><strong>{{ item.line_total|floatformat:2 }} MRU</strong></td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="6" class="text-center text-muted">Aucun article</td>
                </tr>
                {% endfor %}
              </tbody>
              <tfoot class="table-light">
                <tr>
                  <td colspan="5" class="text-end"><strong>Sous-total HT :</strong></td>
                  <td class="text-end"><strong>{{ purchase_order.subtotal|floatformat:2 }} MRU</strong></td>
                </tr>
                <tr>
                  <td colspan="5" class="text-end"><strong>Total Taxes :</strong></td>
                  <td class="text-end"><strong>{{ purchase_order.tax_amount|floatformat:2 }} MRU</strong></td>
                </tr>
                <tr class="table-success">
                  <td colspan="5" class="text-end"><strong class="fs-5">Total TTC :</strong></td>
                  <td class="text-end"><strong class="text-success fs-4">{{ purchase_order.total|floatformat:2 }} MRU</strong></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header bg-light">
          <h5 class="mb-0">Informations de paiement</h5>
        </div>
        <div class="card-body">
          {% if purchase_order.payment_date %}
          <div class="row mb-3">
            <div class="col-sm-4"><strong>Date de paiement :</strong></div>
            <div class="col-sm-8">{{ purchase_order.payment_date|date:"d/m/Y" }}</div>
          </div>
          {% endif %}
          {% if purchase_order.payment_method %}
          <div class="row mb-3">
            <div class="col-sm-4"><strong>Méthode de paiement :</strong></div>
            <div class="col-sm-8">
              {% if purchase_order.payment_method == 'cashbox' %}
                <span class="badge bg-info">Caisse</span>
              {% elif purchase_order.payment_method == 'bank' %}
                <span class="badge bg-primary">Compte bancaire</span>
              {% endif %}
            </div>
          </div>
          {% endif %}
          {% if purchase_order.payment_cashbox %}
          <div class="row mb-3">
            <div class="col-sm-4"><strong>Caisse :</strong></div>
            <div class="col-sm-8">
              <strong>{{ purchase_order.payment_cashbox.folder_code }}</strong><br>
              <small class="text-muted">{{ purchase_order.payment_cashbox.description }}</small>
            </div>
          </div>
          {% endif %}
          {% if purchase_order.payment_bank %}
          <div class="row mb-3">
            <div class="col-sm-4"><strong>Compte bancaire :</strong></div>
            <div class="col-sm-8">
              <strong>{{ purchase_order.payment_bank.bank_name }}</strong><br>
              <small class="text-muted">{{ purchase_order.payment_bank.bank_identifier }} - {{ purchase_order.payment_bank.account_number }}</small>
            </div>
          </div>
          {% endif %}
          {% if purchase_order.payment_date and purchase_order.total %}
          <div class="row mb-3">
            <div class="col-sm-4"><strong>Montant payé :</strong></div>
            <div class="col-sm-8">
              <strong class="text-success fs-5">{{ purchase_order.total|floatformat:2 }} MRU</strong>
            </div>
          </div>
          {% endif %}
          {% if purchase_order.file %}
          <div class="row">
            <div class="col-sm-4"><strong>Justificatif :</strong></div>
            <div class="col-sm-8">
              <a href="{{ purchase_order.file.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                <span class="fas fa-download me-1"></span>Télécharger le justificatif
              </a>
            </div>
          </div>
          {% endif %}
          {% if not purchase_order.payment_date %}
          <div class="alert alert-warning mb-0">
            <span class="fas fa-exclamation-triangle me-2"></span>
            Aucune information de paiement disponible.
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-12 col-xl-4">
      <!-- Actions sur le statut -->
      <div class="card mb-3">
        <div class="card-header bg-light">
          <h5 class="mb-0">Actions</h5>
        </div>
        <div class="card-body">
          {% if purchase_order.status == 'draft' %}
            <div class="d-grid gap-2">
              <a href="{% url 'portal_admin:purchaseorder_pending' purchase_order.pk %}" class="btn btn-warning">
                <span class="fas fa-clock me-2"></span>Mettre en attente
              </a>
              <a href="{% url 'portal_admin:purchaseorder_approve' purchase_order.pk %}" class="btn btn-success">
                <span class="fas fa-check me-2"></span>Approuver
              </a>
              <a href="{% url 'portal_admin:purchaseorder_reject' purchase_order.pk %}" class="btn btn-danger">
                <span class="fas fa-times me-2"></span>Rejeter
              </a>
              <a href="{% url 'portal_admin:purchaseorder_cancel' purchase_order.pk %}" class="btn btn-outline-warning">
                <span class="fas fa-ban me-2"></span>Annuler
              </a>
            </div>
          {% elif purchase_order.status == 'pending' %}
            <div class="d-grid gap-2">
              <a href="{% url 'portal_admin:purchaseorder_approve' purchase_order.pk %}" class="btn btn-success">
                <span class="fas fa-check me-2"></span>Approuver
              </a>
              <a href="{% url 'portal_admin:purchaseorder_reject' purchase_order.pk %}" class="btn btn-danger">
                <span class="fas fa-times me-2"></span>Rejeter
              </a>
              <a href="{% url 'portal_admin:purchaseorder_cancel' purchase_order.pk %}" class="btn btn-outline-warning">
                <span class="fas fa-ban me-2"></span>Annuler
              </a>
            </div>
          {% elif purchase_order.status == 'approved' %}
            <div class="d-grid gap-2">
              <a href="{% url 'portal_admin:purchaseorder_pay' purchase_order.pk %}" class="btn btn-primary">
                <span class="fas fa-money-bill me-2"></span>Marquer comme payé
              </a>
            </div>
          {% elif purchase_order.status == 'paid' %}
            <div class="alert alert-success mb-0">
              <span class="fas fa-check-circle me-2"></span>
              Ce bon de commande a été payé.
            </div>
          {% elif purchase_order.status == 'cancelled' %}
            <div class="alert alert-danger mb-0">
              <span class="fas fa-ban me-2"></span>
              Ce bon de commande a été rejeté.
            </div>
          {% endif %}
        </div>
      </div>

      <div class="card">
        <div class="card-header bg-light">
          <h5 class="mb-0">Métadonnées</h5>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <small class="text-muted">Créé le</small><br>
            <strong>{{ purchase_order.created_at|date:"d/m/Y à H:i" }}</strong>
          </div>
          <div class="mb-3">
            <small class="text-muted">Modifié le</small><br>
            <strong>{{ purchase_order.updated_at|date:"d/m/Y à H:i" }}</strong>
          </div>
          {% if purchase_order.created_by %}
          <div class="mb-3">
            <small class="text-muted">Créé par</small><br>
            <strong>{{ purchase_order.created_by.get_full_name|default:purchase_order.created_by.username }}</strong>
          </div>
          {% endif %}
          {% if purchase_order.approved_by %}
          <div class="mb-3">
            <small class="text-muted">Approuvé par</small><br>
            <strong>{{ purchase_order.approved_by.get_full_name|default:purchase_order.approved_by.username }}</strong><br>
            <small class="text-muted">le {{ purchase_order.approved_at|date:"d/m/Y à H:i" }}</small>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
