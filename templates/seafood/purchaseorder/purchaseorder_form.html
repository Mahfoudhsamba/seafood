{% extends "layouts/base.html" %}
{% load static %}
{% block title %}{% if purchase_order %}Modifier{% else %}Créer{% endif %} un Bon de Commande{% endblock %}

{% block content %}

<div class="pb-5">
  <div class="row align-items-center justify-content-between g-3 mb-4">
    <div class="col-auto">
      <h2 class="mb-0">{% if purchase_order %}Modifier{% else %}Créer{% endif %} un Bon de Commande</h2>
    </div>
    <div class="col-auto">
      <a href="{% url 'portal_admin:purchaseorder_list' %}" class="btn btn-phoenix-secondary">
        <span class="fas fa-arrow-left me-2"></span>Retour
      </a>
    </div>
  </div>

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}


                     
                    


  <div class="row">
    <div class="col-12">
      <form method="post" enctype="multipart/form-data">
        {% csrf_token %}

        <h5 class="mb-3">INFORMATIONS GÉNÉRALES</h5>
        <div class="row g-3 mb-4">
          <div class="col-md-6">
            <label for="po_date" class="form-label">Date <span class="text-danger">*</span></label>
            <input type="date" class="form-control" id="po_date" name="po_date" value="{% if purchase_order %}{{ purchase_order.po_date|date:'Y-m-d' }}{% endif %}" required>
          </div>

          <div class="col-md-6">
            <label for="supplier" class="form-label">Fournisseur <span class="text-danger">*</span></label>
            <select class="form-select" id="supplier" name="supplier" required>
              <option value="" disabled selected>Sélectionner un fournisseur</option>
              {% for sup in suppliers %}
                <option value="{{ sup.pk }}" {% if purchase_order and purchase_order.supplier_id == sup.pk %}selected{% endif %}>
                  {{ sup.accounting_code }} - {{ sup.name }}
                </option>
              {% endfor %}
            </select>
          </div>

        </div>

        <hr>
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="mb-3 mt-4">LES ARTICLES</h5>
          <button type="button" class="btn btn-sm btn-outline-primary" onclick="addPOItemRow()">
            <span class="fas fa-plus me-1"></span>Ajouter un article
          </button>
        </div>
        <div class="row g-3 mb-4">
          <div class="col-12">
            <div class="table-responsive">
              <table class="table table-hover table-striped" id="poItemsTable">
                <thead>
                  <tr>
                    <th scope="col" width="35%">Désignation <span class="text-danger">*</span></th>
                    <th scope="col" width="15%">Quantité <span class="text-danger">*</span></th>
                    <th scope="col" width="15%">Unité <span class="text-danger">*</span></th>
                    <th scope="col" width="15%">Montant <span class="text-danger">*</span></th>
                    <th scope="col" width="15%">Taxe (%)</th>
                    <th scope="col" width="5%">Action</th>
                  </tr>
                </thead>
                <tbody id="poItemsBody">
                  {% if purchase_order and purchase_order.items.all %}
                    {% for item in purchase_order.items.all %}
                      <tr>
                        <td><input type="text" class="form-control" name="designation[]" value="{{ item.designation }}" required></td>
                        <td><input type="number" step="0.01" class="form-control" name="quantity[]" value="{{ item.quantity }}" required></td>
                        <td>
                          <select class="form-select" name="unit[]" required>
                            {% for value, label in units %}
                              <option value="{{ value }}" {% if item.unit == value %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                          </select>
                        </td>
                        <td><input type="number" step="0.01" class="form-control" name="unit_price[]" value="{{ item.unit_price }}" required></td>
                        <td><input type="number" step="0.01" class="form-control" name="tax_rate[]" value="{{ item.tax_rate }}"></td>
                        <td><button type="button" class="btn btn-sm btn-danger" onclick="removePOItemRow(this)"><span class="fas fa-trash"></span></button></td>
                      </tr>
                    {% endfor %}
                  {% else %}
                    <tr>
                      <td><input type="text" class="form-control" name="designation[]" required></td>
                      <td><input type="number" step="0.01" class="form-control" name="quantity[]" required></td>
                      <td>
                        <select class="form-select" name="unit[]" required>
                          {% for value, label in units %}
                            <option value="{{ value }}">{{ label }}</option>
                          {% endfor %}
                        </select>
                      </td>
                      <td><input type="number" step="0.01" class="form-control" name="unit_price[]" required></td>
                      <td><input type="number" step="0.01" class="form-control" name="tax_rate[]" value="0"></td>
                      <td><button type="button" class="btn btn-sm btn-danger" onclick="removePOItemRow(this)"><span class="fas fa-trash"></span></button></td>
                    </tr>
                  {% endif %}
                </tbody>
              </table>
            </div>
          </div>
        </div>

        {% if purchase_order %}
          <h5 class="mb-3">Statut</h5>
          <div class="row g-3 mb-4">
            <div class="col-12">
              <div class="alert alert-info">
                <span class="fas fa-info-circle me-2"></span>
                Le statut du bon de commande peut être modifié depuis la page de détails.
              </div>
            </div>
          </div>
        {% endif %}

        <h5 class="mb-3">COMMENTAIRE</h5>
        <div class="row g-3">
          <div class="col-12">
            <textarea class="form-control" id="note" name="note" rows="3">{% if purchase_order %}{{ purchase_order.note }}{% endif %}</textarea>
          </div>
        </div>
        <div class="mt-4">
          <button type="submit" class="btn btn-primary">
            <span class="fas fa-file me-2"></span>{% if purchase_order %}Modifier{% else %}Faire un bon{% endif %}
          </button>
          <a href="{% url 'portal_admin:purchaseorder_list' %}" class="btn btn-secondary">Annuler</a>
        </div>
      </form>
    </div>
  </div>
</div>


{% endblock %}

{% block extra_js %}
<script>
  // Template pour les options d'unité
  const unitOptions = `{% for value, label in units %}<option value="{{ value }}">{{ label }}</option>{% endfor %}`;

  function addPOItemRow() {
    const tbody = document.getElementById('poItemsBody');
    const row = document.createElement('tr');
    row.innerHTML = `
      <td><input type="text" class="form-control" name="designation[]" required></td>
      <td><input type="number" step="0.01" class="form-control" name="quantity[]" required></td>
      <td><select class="form-select" name="unit[]" required>${unitOptions}</select></td>
      <td><input type="number" step="0.01" class="form-control" name="unit_price[]" required></td>
      <td><input type="number" step="0.01" class="form-control" name="tax_rate[]" value="0"></td>
      <td><button type="button" class="btn btn-sm btn-danger" onclick="removePOItemRow(this)"><span class="fas fa-trash"></span></button></td>
    `;
    tbody.appendChild(row);
  }

  function removePOItemRow(button) {
    const tbody = document.getElementById('poItemsBody');
    if (tbody.children.length > 1) {
      button.closest('tr').remove();
    } else {
      alert('Au moins un article est requis!');
    }
  }

  // Définir la date d'aujourd'hui par défaut pour po_date
  if (!document.getElementById('po_date').value) {
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');
    document.getElementById('po_date').value = `${year}-${month}-${day}`;
  }
</script>
{% endblock %}