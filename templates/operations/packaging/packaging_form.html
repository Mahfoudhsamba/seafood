{% extends "layouts/base.html" %}
{% load static %}

{% block title %}{% if packaging %}Modifier{% else %}Ajouter{% endif %} cartonage{% endblock %}

{% block content %}
<div class="pb-5">
  <div class="row align-items-center justify-content-between g-3 mb-4">
    <div class="col-auto">
      <h2 class="mb-0">{% if packaging %}MODIFIER{% else %}NOUVEAU{% endif %} CARTONAGE</h2>
    </div>
    <div class="col-auto">
      <a href="{% url 'portal_admin:packaging_list' %}" class="btn btn-phoenix-secondary">
        <span class="fas fa-arrow-left me-2"></span>Retour à la liste
      </a>
    </div>
  </div>

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}

  <form method="post" id="packagingForm">
    {% csrf_token %}

    <div class="row g-3">
      <div class="col-lg-12">
        <div class="card mb-3">
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label for="classification" class="form-label">Numéro LOT <span class="text-danger">*</span></label>
                <select name="classification" id="classification" class="form-select" required {% if packaging %}disabled{% endif %}>
                  <option value="">Sélectionner un lot...</option>
                  {% for classification in eligible_classifications %}
                    <option value="{{ classification.pk }}"
                            data-client="{{ classification.reception.client.name }}"
                            data-lot="{{ classification.reception.lot_id }}"
                            data-service="{{ classification.reception.service_type.name }}"
                            data-category-id="{{ classification.reception.service_type.category.pk }}"
                            {% if packaging and packaging.classification.pk == classification.pk %}selected{% endif %}>
                      {{ classification.reception.client.name }} - LOT #{{ classification.reception.lot_id }}
                    </option>
                  {% endfor %}
                </select>
                {% if packaging %}
                  <input type="hidden" name="classification" value="{{ packaging.classification.pk }}">
                {% endif %}
              </div>

              <div class="col-md-6">
                <label for="start_datetime" class="form-label">Date et heure de début <span class="text-danger">*</span></label>
                <input type="datetime-local" name="start_datetime" id="start_datetime" class="form-control" required value="{% if packaging and packaging.start_datetime %}{{ packaging.start_datetime|date:'Y-m-d\TH:i' }}{% endif %}">
                <small class="form-text text-muted">La date ne peut pas être dans le futur</small>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><span class="fas fa-boxes me-2"></span>Cartons par espèce</h5>
            <button type="button" class="btn btn-sm btn-primary" id="addItemBtn" {% if not packaging %}disabled{% endif %}>
              <span class="fas fa-plus me-1"></span>Espèce
            </button>
          </div>
          <div class="card-body">
            <div id="itemsContainer">
              {% if packaging %}
                {% for item in packaging.items.all %}
                  <div class="item-row border p-3 mb-3 rounded">
                    <div class="row g-3">
                      <div class="col-md-10">
                        <label class="form-label">Espèce <span class="text-danger">*</span></label>
                        <select class="form-select item-species" required>
                          <option value="">Sélectionner...</option>
                          {% for species in species_list %}
                            <option value="{{ species.pk }}"
                                    {% if item.species.pk == species.pk %}selected{% endif %}>
                              {{ species.category.name }} - {{ species.name }}
                            </option>
                          {% endfor %}
                        </select>
                      </div>
                      <div class="col-md-1">
                        <label class="form-label">Cartons <span class="text-danger">*</span></label>
                        <input type="number" step="1" min="1" class="form-control item-carton-count" placeholder="0" required value="{{ item.carton_count }}">
                      </div>
                      <div class="col-md-1 d-flex align-items-end">
                        <button type="button" class="btn btn-danger btn-sm remove-item w-100">
                          <span class="fas fa-trash"></span>
                        </button>
                      </div>
                    </div>
                  </div>
                {% endfor %}
              {% endif %}
            </div>
            <div id="noItems" class="text-center py-4 text-muted" {% if packaging and packaging.items.all %}style="display:none;"{% endif %}>
              Aucun élément ajouté. Cliquez sur "Ajouter espèce" pour commencer.
            </div>
          </div>
        </div>
      </div>
    </div>

    <input type="hidden" name="items_data" id="items_data">

    <div class="mt-4 d-flex gap-2">
      <button type="submit" class="btn btn-primary">
        <span class="fas fa-save me-2"></span>{% if packaging %}Mettre à jour{% else %}Enregistrer{% endif %}
      </button>
      <a href="{% url 'portal_admin:packaging_list' %}" class="btn btn-secondary">Annuler</a>
    </div>
  </form>
</div>

{% endblock %}

{% block extra_js %}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const container = document.getElementById('itemsContainer');
      const addBtn = document.getElementById('addItemBtn');
      const noItems = document.getElementById('noItems');
      const form = document.getElementById('packagingForm');
      const classificationSelect = document.getElementById('classification');
      const startDatetimeInput = document.getElementById('start_datetime');

      // Load classification species data from backend
      const classificationSpeciesData = {{ classification_species_json|safe }};
      let currentSpeciesList = [];

      // Function to get current date/time in datetime-local format
      function getNowFormatted() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        return `${year}-${month}-${day}T${hours}:${minutes}`;
      }

      // Set max to current date/time for start_datetime
      if (startDatetimeInput) {
        startDatetimeInput.setAttribute('max', getNowFormatted());
      }

      // When classification is selected, load its species
      classificationSelect.addEventListener('change', function() {
        const classificationId = this.value;
        if (classificationId) {
          // Get species for this classification
          currentSpeciesList = classificationSpeciesData[classificationId] || [];

          // Clear existing items
          container.innerHTML = '';

          // Update all species selects
          updateAllSpeciesSelects();

          // Enable add button
          addBtn.disabled = false;
        } else {
          // No classification selected, disable add button
          addBtn.disabled = true;
          currentSpeciesList = [];
        }
      });

      // Initialize: if classification already selected, load its species
      if (classificationSelect.value) {
        const classificationId = classificationSelect.value;
        currentSpeciesList = classificationSpeciesData[classificationId] || [];
      }

      // Function to update species availability
      function updateSpeciesAvailability() {
        const allSelects = container.querySelectorAll('.item-species');
        const selectedSpecies = new Set();

        // Collect all selected species
        allSelects.forEach(select => {
          if (select.value) {
            selectedSpecies.add(select.value);
          }
        });

        // Update each select
        allSelects.forEach(currentSelect => {
          const currentValue = currentSelect.value;
          const options = currentSelect.querySelectorAll('option');

          options.forEach(option => {
            if (option.value === '') return; // Ignore empty option

            // Disable if selected elsewhere, except if it's the current value
            if (selectedSpecies.has(option.value) && option.value !== currentValue) {
              option.disabled = true;
              option.style.color = '#ccc';
            } else {
              option.disabled = false;
              option.style.color = '';
            }
          });
        });
      }

      // Template for new item
      function getItemTemplate() {
        // Build species options from current species list
        let speciesOptionsHTML = '<option value="">Sélectionner...</option>';
        currentSpeciesList.forEach(species => {
          speciesOptionsHTML += `<option value="${species.pk}">${species.category_name} - ${species.name}</option>`;
        });

        return `
          <div class="item-row border p-3 mb-3 rounded">
            <div class="row g-3">
              <div class="col-md-10">
                <label class="form-label">Espèce <span class="text-danger">*</span></label>
                <select class="form-select item-species" required>
                  ${speciesOptionsHTML}
                </select>
              </div>
              <div class="col-md-1">
                <label class="form-label">Cartons <span class="text-danger">*</span></label>
                <input type="number" step="1" min="1" class="form-control item-carton-count" placeholder="0" required>
              </div>
              <div class="col-md-1 d-flex align-items-end">
                <button type="button" class="btn btn-danger btn-sm remove-item w-100">
                  <span class="fas fa-trash"></span>
                </button>
              </div>
            </div>
          </div>
        `;
      }

      // Function to update all species selects with current species list
      function updateAllSpeciesSelects() {
        const allSpeciesSelects = container.querySelectorAll('.item-species');
        allSpeciesSelects.forEach(select => {
          const currentValue = select.value;

          // Rebuild options
          select.innerHTML = '<option value="">Sélectionner...</option>';
          currentSpeciesList.forEach(species => {
            const option = document.createElement('option');
            option.value = species.pk;
            option.textContent = `${species.category_name} - ${species.name}`;
            if (species.pk == currentValue) {
              option.selected = true;
            }
            select.appendChild(option);
          });
        });

        // After updating, check availability
        updateSpeciesAvailability();
      }

      // Add new item
      addBtn.addEventListener('click', function() {
        const div = document.createElement('div');
        div.innerHTML = getItemTemplate();
        const itemRow = div.firstElementChild;
        container.prepend(itemRow);
        noItems.style.display = 'none';

        // Attach events to new select
        const speciesSelect = itemRow.querySelector('.item-species');
        speciesSelect.addEventListener('change', updateSpeciesAvailability);

        // Attach delete event
        const removeBtn = itemRow.querySelector('.remove-item');
        removeBtn.addEventListener('click', function() {
          itemRow.remove();
          if (container.children.length === 0) {
            noItems.style.display = 'block';
          }
          updateSpeciesAvailability(); // Update after deletion
        });

        updateSpeciesAvailability(); // Update immediately
      });

      // Attach events to existing items
      document.querySelectorAll('.item-species').forEach(select => {
        select.addEventListener('change', updateSpeciesAvailability);
      });

      document.querySelectorAll('.remove-item').forEach(btn => {
        btn.addEventListener('click', function() {
          const row = this.closest('.item-row');
          row.remove();
          if (container.children.length === 0) {
            noItems.style.display = 'block';
          }
          updateSpeciesAvailability(); // Update after deletion
        });
      });

      // Initialize availability on load
      updateSpeciesAvailability();

      // Auto-add one line on load if container is empty (add mode) and classification selected
      if (container.children.length === 0 && classificationSelect.value) {
        addBtn.click(); // Simulate click on "Add species" button
      }

      // Collect data before submission
      form.addEventListener('submit', function(e) {
        // Validate start datetime is not in the future
        if (startDatetimeInput && startDatetimeInput.value) {
          const selectedDate = new Date(startDatetimeInput.value);
          const now = new Date();

          if (selectedDate > now) {
            e.preventDefault();
            alert('Erreur : La date et l\'heure de début ne peuvent pas être dans le futur.');
            startDatetimeInput.focus();
            return;
          }
        }

        const items = [];
        const itemRows = container.querySelectorAll('.item-row');
        const speciesSet = new Set();

        itemRows.forEach(row => {
          const species = row.querySelector('.item-species').value;
          const cartonCount = row.querySelector('.item-carton-count').value;

          if (species && cartonCount) {
            // Check duplicates
            if (speciesSet.has(species)) {
              e.preventDefault();
              alert('Erreur : Vous ne pouvez pas sélectionner la même espèce plusieurs fois !');
              return;
            }
            speciesSet.add(species);

            items.push({
              species: parseInt(species),
              carton_count: parseInt(cartonCount)
            });
          }
        });

        // Check at least one species
        if (items.length === 0) {
          e.preventDefault();
          alert('Erreur : Vous devez ajouter au moins une espèce pour créer le cartonage !');
          return;
        }

        document.getElementById('items_data').value = JSON.stringify(items);
      });
    });
  </script>
{% endblock %}
